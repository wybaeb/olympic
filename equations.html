<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>–†–µ—à–∞–µ–º —É—Ä–∞–≤–Ω–µ–Ω–∏—è - —Ä–∞–∑–≤–∏–≤–∞—é—â–∞—è –∏–≥—Ä–∞</title>
<style>
    html,body{
        margin:0;
        padding:0;
        font-family:Arial, Helvetica, sans-serif;
        background:#f5f5f5;
        display:flex;
        flex-direction:column;
        align-items:center;
    }
    h1{margin:20px 0 10px;font-size:1.6rem;}
    .game-info {
        display: flex;
        justify-content: space-between;
        width: 600px;
        padding: 10px 0;
        margin-bottom: 10px;
        font-size: 1.2rem;
        align-items: center;
    }
    .level {
        font-weight: bold;
        color: #2196F3;
    }
    .progress {
        color: #4CAF50;
        font-weight: bold;
    }
    .equations-container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        margin: 20px 0;
        width: 600px;
    }
    .equation {
        font-size: 3rem;
        margin: 15px 0;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 4px;
        text-align: center;
    }
    .input-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
        margin-top: 15px;
        width: 100%;
        max-width: 600px;
    }
    .input-row {
        display: flex;
        align-items: center;
        gap: 10px;
        width: 100%;
        justify-content: center;
    }
    .input-field {
        display: flex;
        align-items: center;
        gap: 5px;
    }
    .input-field input {
        width: 80px;
        padding: 8px;
        font-size: 1.2rem;
        border: 2px solid #ccc;
        border-radius: 4px;
        text-align: center;
    }
    .input-field input:focus {
        border-color: #2196F3;
        outline: none;
    }
    .input-field input:disabled {
        background-color: #f0f0f0;
        color: #333;
        font-weight: bold;
    }
    .emoji-icon {
        font-size: 1.5rem;
        width: 30px;
        text-align: center;
    }
    .btn-next {
        padding: 12px 24px;
        background: #4CAF50;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1.4rem;
        margin-top: 10px;
        width: 200px;
    }
    .btn-next:hover {
        background: #45a049;
    }
    .message {
        margin-top: 15px;
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: bold;
        font-size: 1.2rem;
        text-align: center;
        opacity: 0;
        transition: opacity 0.3s ease;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        min-width: 300px;
    }
    .success {
        background-color: rgba(76, 175, 80, 0.9);
        color: white;
    }
    .error {
        background-color: rgba(244, 67, 54, 0.9);
        color: white;
    }
    .level-up {
        background-color: rgba(33, 150, 243, 0.9);
        color: white;
        font-size: 1.5rem;
    }
    .game-container {
        position: relative;
    }
    .emoji-key {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin: 20px 0;
        font-size: 1.2rem;
    }
    .emoji-pair {
        display: flex;
        align-items: center;
        gap: 5px;
    }
</style>
</head>
<body>
<h1>–†–µ—à–∞–µ–º —É—Ä–∞–≤–Ω–µ–Ω–∏—è!</h1>

<div class="game-info">
    <div class="level">–£—Ä–æ–≤–µ–Ω—å: <span id="currentLevel">1</span></div>
    <div class="progress">–ü—Ä–æ–≥—Ä–µ—Å—Å: <span id="progress">0/3</span></div>
</div>

<div class="emoji-key" id="emojiKey"></div>

<div class="equations-container" id="equationsContainer"></div>

<div class="input-container">
    <div class="input-row">
        <div class="input-field">
            <span class="emoji-icon" id="emojiA"></span>
            <input type="number" id="answerA" disabled>
        </div>
        <div class="input-field">
            <span class="emoji-icon" id="emojiB"></span>
            <input type="number" id="answerB" placeholder="?">
        </div>
        <div class="input-field">
            <span class="emoji-icon" id="emojiC"></span>
            <input type="number" id="answerC" placeholder="?">
        </div>
        <div class="input-field">
            <span class="emoji-icon" id="emojiD"></span>
            <input type="number" id="answerD" placeholder="?">
        </div>
    </div>
    <button id="btnNext" class="btn-next">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
</div>

<div id="message" class="message"></div>

<script>
(function(){
    const levelEl = document.getElementById('currentLevel');
    const progressEl = document.getElementById('progress');
    const equationsContainer = document.getElementById('equationsContainer');
    const emojiKey = document.getElementById('emojiKey');
    const messageEl = document.getElementById('message');
    const btnNext = document.getElementById('btnNext');
    const answerA = document.getElementById('answerA');
    const answerB = document.getElementById('answerB');
    const answerC = document.getElementById('answerC');
    const answerD = document.getElementById('answerD');
    const emojiA = document.getElementById('emojiA');
    const emojiB = document.getElementById('emojiB');
    const emojiC = document.getElementById('emojiC');
    const emojiD = document.getElementById('emojiD');

    // –ò–≥—Ä–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
    let currentLevel = 1;
    let successCount = 0;
    let currentEquations = [];
    let currentValues = {};
    let emojiMap = {};
    const SECRET_KEY = "3qu4t10n2024";

    // Emoji –¥–ª—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
    const emojis = ['üê∂', 'üê±', 'üê∞', 'ü¶ä', 'üêº', 'ü¶Å', 'üêØ', 'üê®', 'üêÆ', 'üê∑', 'üê∏', 'üêô', 'ü¶Ñ', 'ü¶í', 'ü¶ò', 'ü¶õ'];

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ —á–∏—Å–ª–∞ –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ
    function rand(min, max) { 
        return Math.floor(Math.random() * (max - min + 1)) + min; 
    }

    // –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–Ω–∏–µ –º–∞—Å—Å–∏–≤–∞
    function shuffle(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è
    function createNewTask() {
        // –û—á–∏—â–∞–µ–º –ø–æ–ª—è –≤–≤–æ–¥–∞
        answerB.value = '';
        answerC.value = '';
        answerD.value = '';
        answerB.focus();

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω –¥–ª—è –∑–Ω–∞—á–µ–Ω–∏–π
        const X = 5 + (currentLevel - 1);
        const n = 4;
        const min = X - n;
        const max = X + n;

        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∑–Ω–∞—á–µ–Ω–∏—è
        currentValues = {
            A: rand(min, max),
            B: rand(min, max),
            C: rand(min, max),
            D: rand(min, max)
        };

        // –°–æ–∑–¥–∞–µ–º –º–∞–ø–ø–∏–Ω–≥ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –Ω–∞ —ç–º–æ–¥–∑–∏
        const variables = ['A', 'B', 'C', 'D'];
        const availableEmojis = [...emojis];
        emojiMap = {};
        variables.forEach(v => {
            const randomIndex = rand(0, availableEmojis.length - 1);
            emojiMap[v] = availableEmojis.splice(randomIndex, 1)[0];
        });

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ A –∏ —ç–º–æ–¥–∑–∏
        answerA.value = currentValues.A;
        emojiA.textContent = emojiMap['A'];
        emojiB.textContent = emojiMap['B'];
        emojiC.textContent = emojiMap['C'];
        emojiD.textContent = emojiMap['D'];

        // –°–æ–∑–¥–∞–µ–º —É—Ä–∞–≤–Ω–µ–Ω–∏—è
        currentEquations = [
            { left: ['A', 'A', 'B', 'B'], right: 2 * currentValues.A + 2 * currentValues.B },
            { left: ['A', 'A', 'B', 'C'], right: 2 * currentValues.A + currentValues.B + currentValues.C },
            { left: ['A', 'B', 'B', 'D'], right: currentValues.A + 2 * currentValues.B + currentValues.D },
            { left: ['A', 'B', 'C', 'D'], right: currentValues.A + currentValues.B + currentValues.C + currentValues.D }
        ];

        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —É—Ä–∞–≤–Ω–µ–Ω–∏—è
        displayEquations();
        displayEmojiKey();
    }

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É—Ä–∞–≤–Ω–µ–Ω–∏–π
    function displayEquations() {
        equationsContainer.innerHTML = '';
        
        // –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º —É—Ä–∞–≤–Ω–µ–Ω–∏—è
        const shuffledEquations = shuffle([...currentEquations]);
        
        shuffledEquations.forEach(eq => {
            const shuffledLeft = shuffle([...eq.left]);
            const equationDiv = document.createElement('div');
            equationDiv.className = 'equation';
            equationDiv.textContent = `${shuffledLeft.map(v => emojiMap[v]).join(' + ')} = ${eq.right}`;
            equationsContainer.appendChild(equationDiv);
        });
    }

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–ª—é—á–∞ —ç–º–æ–¥–∑–∏
    function displayEmojiKey() {
        emojiKey.innerHTML = '';
        Object.entries(emojiMap).forEach(([variable, emoji]) => {
            const pair = document.createElement('div');
            pair.className = 'emoji-pair';
            pair.textContent = `${emoji} = ${variable}`;
            emojiKey.appendChild(pair);
        });
    }

    // –ü–æ–∫–∞–∑ —Å–æ–æ–±—â–µ–Ω–∏—è
    function showMessage(text, type) {
        messageEl.textContent = text;
        messageEl.className = `message ${type}`;
        messageEl.style.opacity = 1;
        
        setTimeout(() => {
            messageEl.style.opacity = 0;
        }, 2000);
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–≤–µ—Ç–∞
    function checkAnswer() {
        const userB = parseInt(answerB.value);
        const userC = parseInt(answerC.value);
        const userD = parseInt(answerD.value);

        if (isNaN(userB) || isNaN(userC) || isNaN(userD)) {
            showMessage('–í–≤–µ–¥–∏—Ç–µ –≤—Å–µ —á–∏—Å–ª–∞!', 'error');
            return;
        }

        if (userB === currentValues.B && 
            userC === currentValues.C && 
            userD === currentValues.D) {
            // –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
            successCount++;
            
            if (successCount >= 3) {
                // –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å
                currentLevel++;
                successCount = 0;
                levelEl.textContent = currentLevel;
                showMessage(`–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –£—Ä–æ–≤–µ–Ω—å ${currentLevel}`, 'level-up');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ö–µ—à –≤ URL
                updateLevelHash();
            } else {
                showMessage('–ü—Ä–∞–≤–∏–ª—å–Ω–æ!', 'success');
            }
            
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ
            setTimeout(createNewTask, 1500);
        } else {
            // –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
            successCount = 0;
            showMessage('–ù–µ–≤–µ—Ä–Ω–æ! –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑', 'error');
            progressEl.textContent = `${successCount}/3`;
            
            // –ó–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –Ω–æ–≤—ã–º –∑–∞–¥–∞–Ω–∏–µ–º
            setTimeout(createNewTask, 2500);
        }
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    btnNext.addEventListener('click', checkAnswer);
    [answerB, answerC, answerD].forEach(input => {
        input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                checkAnswer();
            }
        });
    });

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ö–µ—à–∞ –≤ URL –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–≥–æ —É—Ä–æ–≤–Ω—è
    function checkLevelFromHash() {
        const hash = window.location.hash.substr(1);
        if (hash && hash.length > 0) {
            try {
                const level = decodeLevelFromHash(hash);
                if (level && level > 0 && level <= 100) {
                    currentLevel = level;
                    console.log(`–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —É—Ä–æ–≤–µ–Ω—å: ${level} –∏–∑ —Ö–µ—à–∞`);
                }
            } catch (e) {
                console.log("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ö–µ—à —É—Ä–æ–≤–Ω—è");
            }
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ö–µ—à–∞ –≤ URL –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —É—Ä–æ–≤–Ω—è
    function updateLevelHash() {
        const hash = encodeLevelToHash(currentLevel);
        window.location.hash = hash;
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–ª–æ–∂–Ω–æ–≥–æ —Ö–µ—à–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–æ–º–µ—Ä–∞ —É—Ä–æ–≤–Ω—è
    function encodeLevelToHash(level) {
        const salt = generateRandomString(5);
        const levelStr = level.toString().padStart(3, '0');
        
        let encoded = '';
        for (let i = 0; i < levelStr.length; i++) {
            const charCode = levelStr.charCodeAt(i);
            const keyChar = SECRET_KEY.charCodeAt(i % SECRET_KEY.length);
            encoded += String.fromCharCode(charCode ^ keyChar);
        }
        
        const timestamp = Date.now() % 10000;
        const dataToEncode = salt + encoded + timestamp.toString();
        
        return btoa(dataToEncode).replace(/=/g, '').replace(/\+/g, '-').replace(/\//g, '_');
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è —Ö–µ—à–∞ –≤ –Ω–æ–º–µ—Ä —É—Ä–æ–≤–Ω—è
    function decodeLevelFromHash(hash) {
        try {
            const decoded = atob(hash.replace(/-/g, '+').replace(/_/g, '/'));
            const encodedLevel = decoded.substr(5, 3);
            
            let levelStr = '';
            for (let i = 0; i < encodedLevel.length; i++) {
                const charCode = encodedLevel.charCodeAt(i);
                const keyChar = SECRET_KEY.charCodeAt(i % SECRET_KEY.length);
                levelStr += String.fromCharCode(charCode ^ keyChar);
            }
            
            return parseInt(levelStr, 10);
        } catch (e) {
            console.error("–û—à–∏–±–∫–∞ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è —Ö–µ—à–∞", e);
            return null;
        }
    }

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ –∑–∞–¥–∞–Ω–Ω–æ–π –¥–ª–∏–Ω—ã
    function generateRandomString(length) {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        let result = '';
        for (let i = 0; i < length; i++) {
            result += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return result;
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä—ã
    function initGame() {
        checkLevelFromHash();
        levelEl.textContent = currentLevel;
        createNewTask();
    }

    // –ó–∞–ø—É—Å–∫ –∏–≥—Ä—ã
    initGame();
})();
</script>
</body>
</html> 